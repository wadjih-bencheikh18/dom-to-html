<html>
  <head> </head>
  <body>
    <button onclick="toCopy()">Copy</button>
    <div id="toCopy">
      <h1>Test copy DOM element as HTML</h1>
      <h2>this is a jpg image</h2>
      <img src="test.jpg" />
      <img
        src="https://upload.wikimedia.org/wikipedia/commons/7/77/Delete_key1.jpg"
      />
      <h2>this is a svg image</h2>
      <img src="test.svg" />
      <svg height="80" width="300">
        <g fill="none" stroke="black" stroke-width="4">
          <path stroke-dasharray="5,5" d="M5 20 l215 0" />
          <path stroke-dasharray="10,10" d="M5 40 l215 0" />
          <path stroke-dasharray="20,10,5,5,5,10" d="M5 60 l215 0" />
          <path stroke-dasharray="20,10,5,5,5,10" d="M5 60 l215 0" />
          <path stroke-dasharray="20,10,5,5,5,10" d="M5 60 l215 0" />
          <path stroke-dasharray="20,10,5,5,5,10" d="M5 60 l215 0" />
          <path stroke-dasharray="20,10,5,5,5,10" d="M5 60 l215 0" />
        </g>
      </svg>
    </div>

    <script type="text/javascript">
      async function toCopy() {
        const html = await domToHtml(document.getElementById('toCopy'));
        copyHTMLToClipboard(html);
      }
      function copyHTMLToClipboard(html) {
        const type = 'text/html';
        if (typeof ClipboardItem === 'undefined') {
          alert('Copy to clipboard not supported in this browser');
          return;
        }
        const blob = new Blob([html], { type });
        const data = [new ClipboardItem({ [type]: blob })];

        navigator.clipboard.write(data).then(
          () => {
            alert('Copied to clipboard');
          },
          () => {
            alert('Failed to copy to clipboard');
          },
        );
      }

      async function domToHtml(dom) {
        if (dom === null || !dom.innerHTML) {
          return '';
        }
        const domCopy = dom.cloneNode(true);

        const canvases = dom.querySelectorAll('canvas');
        const canvasesCopy = domCopy.querySelectorAll('canvas');
        for (let i = 0; i < canvases.length; i++) {
          canvasesCopy[i].outerHTML = canvasToHtml(canvases[i]);
        }

        const svgs = dom.querySelectorAll('svg');
        const svgsCopy = domCopy.querySelectorAll('svg');
        for (let i = 0; i < svgs.length; i++) {
          svgsCopy[i].outerHTML = svgToHtml(svgs[i]);
        }

        const imgs = dom.querySelectorAll('img');
        const imgsCopy = domCopy.querySelectorAll('img');
        for (let i = 0; i < imgs.length; i++) {
          imgsCopy[i].outerHTML = await imgToHtml(imgs[i]);
        }

        return domCopy.innerHTML;
      }

      function canvasToHtml(canvas) {
        const png = canvas.toDataURL('image/png');
        return `<img src="${png}" />`;
      }
      function svgToHtml(svg) {
        const svgXml = new XMLSerializer().serializeToString(svg);
        const base64 = btoa(svgXml);
        return `<img src="data:image/svg+xml;base64,${base64}" />`;
      }
      async function imgToHtml(img) {
        const url = img.src;
        const r = await fetch(url)
          .then((r) => r.blob())
          .then(
            (b) =>
              new Promise((resolve, _) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(b);
              }),
          );
        return `<img src="${base64}" />`;
      }
    </script>
  </body>
</html>
